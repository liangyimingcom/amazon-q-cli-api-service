# 功能测试矩阵

## 测试目标
验证Amazon Q CLI API服务的核心功能是否按照规格说明正确实现。

## 测试环境
- 服务地址: http://localhost:8080
- 测试工具: pytest, requests, curl
- 数据格式: JSON

## 1. AI对话处理功能

### 1.1 基础对话功能
| 测试用例ID | 测试描述 | 输入数据 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| F001 | 简单问候消息 | "你好" | 返回中文问候回复 | 高 |
| F002 | 技术问题咨询 | "如何使用Python创建列表？" | 返回技术解答 | 高 |
| F003 | 代码生成请求 | "请写一个Python函数计算斐波那契数列" | 返回Python代码 | 高 |
| F004 | 空消息处理 | "" | 返回错误提示 | 中 |
| F005 | 超长消息处理 | 4000+字符消息 | 返回长度限制错误 | 中 |
| F006 | 特殊字符处理 | 包含emoji和特殊符号 | 正常处理并回复 | 低 |

**测试脚本示例:**
```python
def test_basic_conversation():
    """测试基础对话功能"""
    response = requests.post(
        f"{BASE_URL}/api/v1/chat",
        json={"message": "你好"}
    )
    assert response.status_code == 200
    data = response.json()
    assert "message" in data
    assert len(data["message"]) > 0
```

### 1.2 上下文保持功能
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| F007 | 单会话上下文保持 | 1.创建会话<br>2.发送"我叫张三"<br>3.发送"我叫什么名字？" | 第3步回复包含"张三" | 高 |
| F008 | 多轮对话连续性 | 连续发送5条相关消息 | 每条回复都考虑前面的上下文 | 高 |
| F009 | 上下文长度限制 | 发送超过MAX_HISTORY_LENGTH条消息 | 自动清理旧消息，保持最新消息 | 中 |
| F010 | 跨会话上下文隔离 | 在不同会话中发送相同问题 | 不同会话间无上下文共享 | 高 |

**测试脚本示例:**
```python
def test_context_preservation():
    """测试上下文保持功能"""
    # 创建会话
    session_resp = requests.post(f"{BASE_URL}/api/v1/sessions")
    session_id = session_resp.json()["session_id"]
    
    # 第一条消息
    requests.post(f"{BASE_URL}/api/v1/chat", json={
        "session_id": session_id,
        "message": "我叫张三"
    })
    
    # 第二条消息测试上下文
    response = requests.post(f"{BASE_URL}/api/v1/chat", json={
        "session_id": session_id,
        "message": "我叫什么名字？"
    })
    
    assert "张三" in response.json()["message"]
```

## 2. 流式回复功能

### 2.1 Server-Sent Events (SSE)
| 测试用例ID | 测试描述 | 输入数据 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| F011 | 基础流式回复 | "请详细介绍Python" | 分块接收回复内容 | 高 |
| F012 | 流式事件格式 | 任意消息 | 事件格式符合SSE标准 | 高 |
| F013 | 流式传输完成 | 任意消息 | 最后发送done事件 | 高 |
| F014 | 流式错误处理 | 触发错误的消息 | 发送error事件 | 中 |
| F015 | 连接中断处理 | 客户端主动断开连接 | 服务端正确清理资源 | 中 |

**测试脚本示例:**
```python
def test_streaming_response():
    """测试流式回复功能"""
    import sseclient
    
    response = requests.post(
        f"{BASE_URL}/api/v1/chat/stream",
        json={"message": "请详细介绍Python"},
        stream=True
    )
    
    client = sseclient.SSEClient(response)
    events = []
    
    for event in client.events():
        events.append(json.loads(event.data))
        if event.data and json.loads(event.data).get("type") == "done":
            break
    
    assert len(events) > 1
    assert events[-1]["type"] == "done"
```

## 3. 会话管理功能

### 3.1 会话生命周期
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| F016 | 会话创建 | POST /api/v1/sessions | 返回有效的session_id | 高 |
| F017 | 会话信息查询 | GET /api/v1/sessions/{id} | 返回会话详细信息 | 高 |
| F018 | 会话删除 | DELETE /api/v1/sessions/{id} | 成功删除会话 | 高 |
| F019 | 不存在会话查询 | 查询不存在的会话ID | 返回404错误 | 中 |
| F020 | 会话自动过期 | 等待SESSION_EXPIRY时间 | 会话自动失效 | 中 |

### 3.2 会话并发处理
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| F021 | 多会话并发创建 | 同时创建10个会话 | 所有会话都成功创建 | 高 |
| F022 | 多会话并发聊天 | 在多个会话中同时发送消息 | 所有消息都得到正确回复 | 高 |
| F023 | 会话间数据隔离 | 不同会话发送不同消息 | 回复内容不会混淆 | 高 |

**测试脚本示例:**
```python
def test_session_lifecycle():
    """测试会话生命周期"""
    # 创建会话
    create_resp = requests.post(f"{BASE_URL}/api/v1/sessions")
    assert create_resp.status_code == 200
    session_id = create_resp.json()["session_id"]
    
    # 查询会话
    get_resp = requests.get(f"{BASE_URL}/api/v1/sessions/{session_id}")
    assert get_resp.status_code == 200
    assert get_resp.json()["session_id"] == session_id
    
    # 删除会话
    delete_resp = requests.delete(f"{BASE_URL}/api/v1/sessions/{session_id}")
    assert delete_resp.status_code == 200
    
    # 验证删除
    get_resp2 = requests.get(f"{BASE_URL}/api/v1/sessions/{session_id}")
    assert get_resp2.status_code == 404
```

## 4. 会话隔离功能

### 4.1 工作目录管理
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| F024 | 会话目录创建 | 创建新会话 | 自动创建对应的工作目录 | 高 |
| F025 | 会话目录隔离 | 在不同会话中创建同名文件 | 文件在各自目录中，不冲突 | 高 |
| F026 | 会话文件列表 | GET /api/v1/sessions/{id}/files | 返回会话目录中的文件列表 | 高 |
| F027 | 会话目录清理 | 删除会话 | 对应的工作目录被清理 | 中 |

### 4.2 文件操作隔离
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| F028 | 文件创建隔离 | 在不同会话中请求创建文件 | 文件在各自会话目录中 | 高 |
| F029 | 文件读取隔离 | 读取其他会话的文件 | 无法访问其他会话文件 | 高 |
| F030 | 目录权限控制 | 尝试访问系统目录 | 被限制在会话目录内 | 高 |

**测试脚本示例:**
```python
def test_session_isolation():
    """测试会话隔离功能"""
    # 创建两个会话
    session1 = requests.post(f"{BASE_URL}/api/v1/sessions").json()["session_id"]
    session2 = requests.post(f"{BASE_URL}/api/v1/sessions").json()["session_id"]
    
    # 在会话1中创建文件
    requests.post(f"{BASE_URL}/api/v1/chat", json={
        "session_id": session1,
        "message": "请创建一个名为test.py的文件"
    })
    
    # 检查会话1的文件列表
    files1 = requests.get(f"{BASE_URL}/api/v1/sessions/{session1}/files")
    assert any(f["name"] == "test.py" for f in files1.json()["files"])
    
    # 检查会话2的文件列表（应该为空）
    files2 = requests.get(f"{BASE_URL}/api/v1/sessions/{session2}/files")
    assert not any(f["name"] == "test.py" for f in files2.json()["files"])
```

## 5. 健康监控功能

### 5.1 健康检查接口
| 测试用例ID | 测试描述 | 输入数据 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| F031 | 基础健康检查 | GET /health | 返回健康状态信息 | 高 |
| F032 | Q CLI可用性检查 | GET /health | qcli_available字段正确 | 高 |
| F033 | 活跃会话统计 | GET /health | active_sessions字段准确 | 中 |
| F034 | 服务信息查询 | GET / | 返回服务基本信息 | 中 |

**测试脚本示例:**
```python
def test_health_check():
    """测试健康检查功能"""
    response = requests.get(f"{BASE_URL}/health")
    assert response.status_code == 200
    
    data = response.json()
    assert "status" in data
    assert "qcli_available" in data
    assert "active_sessions" in data
    assert "timestamp" in data
    
    assert data["status"] in ["healthy", "degraded", "unhealthy"]
    assert isinstance(data["qcli_available"], bool)
    assert isinstance(data["active_sessions"], int)
```

## 测试执行计划

### 阶段1: 核心功能验证（高优先级）
- F001-F006: AI对话处理基础功能
- F007-F010: 上下文保持功能
- F016-F018: 会话管理基础功能
- F024-F026: 会话隔离基础功能

### 阶段2: 高级功能验证（中优先级）
- F011-F015: 流式回复功能
- F019-F023: 会话管理高级功能
- F027-F030: 会话隔离高级功能
- F031-F034: 健康监控功能

### 阶段3: 边界情况验证（低优先级）
- 异常输入处理
- 性能边界测试
- 资源清理验证

## 成功标准

- 所有高优先级测试用例通过率 ≥ 95%
- 所有中优先级测试用例通过率 ≥ 90%
- 所有低优先级测试用例通过率 ≥ 80%
- 无严重功能缺陷
- 性能指标满足要求

## 测试数据清理

测试完成后需要清理：
- 临时创建的会话
- 测试过程中生成的文件
- 测试日志和临时数据