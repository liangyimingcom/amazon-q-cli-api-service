# 会话管理测试矩阵

## 测试目标
验证会话管理功能的完整性，包括会话创建、查询、删除、过期处理和并发管理。

## 测试环境
- 服务地址: http://localhost:8080
- 测试工具: pytest, requests, threading
- 配置: SESSION_EXPIRY=3600, MAX_HISTORY_LENGTH=10

## 1. 会话生命周期管理

### 1.1 会话创建测试
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| SM001 | 单个会话创建 | POST /api/v1/sessions | 返回唯一session_id | 高 |
| SM002 | 批量会话创建 | 连续创建100个会话 | 所有session_id唯一 | 高 |
| SM003 | 会话ID格式验证 | 创建会话后检查ID格式 | 符合UUID v4格式 | 高 |
| SM004 | 会话创建时间记录 | 创建会话后检查created_at | 时间戳准确 | 中 |
| SM005 | 会话工作目录创建 | 创建会话后检查目录 | 自动创建对应目录 | 高 |

### 1.2 会话查询测试
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| SM006 | 查询存在的会话 | GET /api/v1/sessions/{id} | 返回完整会话信息 | 高 |
| SM007 | 查询不存在的会话 | 使用无效ID查询 | 返回404错误 | 高 |
| SM008 | 会话信息完整性 | 查询会话信息 | 包含所有必需字段 | 高 |
| SM009 | 会话活动时间更新 | 发送消息后查询 | last_activity更新 | 中 |
| SM010 | 会话消息计数 | 发送多条消息后查询 | message_count准确 | 中 |

### 1.3 会话删除测试
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| SM011 | 删除存在的会话 | DELETE /api/v1/sessions/{id} | 成功删除 | 高 |
| SM012 | 删除不存在的会话 | 删除无效ID | 返回404错误 | 高 |
| SM013 | 删除后验证 | 删除后再次查询 | 确认会话不存在 | 高 |
| SM014 | 工作目录清理 | 删除会话后检查目录 | 对应目录被清理 | 高 |
| SM015 | 重复删除处理 | 多次删除同一会话 | 第二次返回404 | 中 |#
# 2. 会话过期管理

### 2.1 自动过期测试
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| SM016 | 会话过期时间设置 | 创建会话并等待 | 超过SESSION_EXPIRY后过期 | 高 |
| SM017 | 过期会话访问 | 访问过期会话 | 返回404或过期错误 | 高 |
| SM018 | 活动会话续期 | 在过期前发送消息 | 会话过期时间重置 | 高 |
| SM019 | 过期会话清理 | 等待自动清理 | 过期会话被自动删除 | 中 |
| SM020 | 批量过期处理 | 多个会话同时过期 | 所有过期会话被清理 | 中 |

### 2.2 过期策略测试
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| SM021 | 最后活动时间更新 | 发送消息 | last_activity时间更新 | 高 |
| SM022 | 只读操作不续期 | 只查询会话信息 | 不更新last_activity | 中 |
| SM023 | 流式聊天续期 | 进行流式对话 | 正确更新活动时间 | 中 |
| SM024 | 文件操作续期 | 查询会话文件 | 更新活动时间 | 低 |

## 3. 会话并发管理

### 3.1 并发创建测试
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| SM025 | 高并发会话创建 | 50个线程同时创建会话 | 所有会话成功创建 | 高 |
| SM026 | 会话ID唯一性 | 并发创建1000个会话 | 所有ID唯一 | 高 |
| SM027 | 并发创建性能 | 测量并发创建时间 | 响应时间合理 | 中 |
| SM028 | 资源竞争处理 | 高并发下的资源访问 | 无死锁或竞争条件 | 高 |

### 3.2 并发操作测试
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| SM029 | 并发聊天处理 | 多个会话同时发送消息 | 所有消息正确处理 | 高 |
| SM030 | 并发查询处理 | 同时查询多个会话 | 返回正确的会话信息 | 高 |
| SM031 | 并发删除处理 | 同时删除多个会话 | 所有会话正确删除 | 高 |
| SM032 | 混合操作并发 | 同时进行增删改查 | 所有操作正确执行 | 高 |

## 4. 会话数据一致性

### 4.1 数据完整性测试
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| SM033 | 会话数据持久化 | 重启服务后检查会话 | 会话数据保持一致 | 高 |
| SM034 | 消息历史完整性 | 发送多条消息后查询 | 历史消息完整保存 | 高 |
| SM035 | 会话状态一致性 | 各种操作后检查状态 | 状态信息准确 | 高 |
| SM036 | 工作目录一致性 | 检查目录与会话对应关系 | 目录结构正确 | 高 |

### 4.2 异常恢复测试
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| SM037 | 服务重启恢复 | 重启服务后检查会话 | 活跃会话正常恢复 | 中 |
| SM038 | 异常中断恢复 | 模拟异常中断后恢复 | 数据不丢失 | 中 |
| SM039 | 部分失败处理 | 部分操作失败时的处理 | 保持数据一致性 | 中 |

## 5. 会话资源管理

### 5.1 内存使用测试
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| SM040 | 会话内存占用 | 创建大量会话 | 内存使用合理 | 中 |
| SM041 | 历史消息限制 | 发送超过限制的消息 | 自动清理旧消息 | 高 |
| SM042 | 内存泄漏检测 | 长时间运行测试 | 无内存泄漏 | 中 |
| SM043 | 垃圾回收效果 | 删除会话后检查内存 | 内存正确释放 | 中 |

### 5.2 存储空间管理
| 测试用例ID | 测试描述 | 测试步骤 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| SM044 | 工作目录空间 | 在会话中创建大文件 | 空间使用合理 | 中 |
| SM045 | 目录清理效果 | 删除会话后检查磁盘 | 目录完全清理 | 高 |
| SM046 | 空间限制处理 | 磁盘空间不足时 | 优雅处理错误 | 低 |

## 测试脚本示例

```python
import requests
import threading
import time
import uuid
import pytest

BASE_URL = "http://localhost:8080"

class TestSessionManagement:
    
    def test_session_creation(self):
        """SM001: 测试单个会话创建"""
        response = requests.post(f"{BASE_URL}/api/v1/sessions")
        assert response.status_code == 200
        
        data = response.json()
        assert "session_id" in data
        assert "created_at" in data
        
        # 验证UUID格式
        session_id = data["session_id"]
        uuid.UUID(session_id)  # 验证UUID格式
    
    def test_concurrent_session_creation(self):
        """SM025: 测试高并发会话创建"""
        session_ids = []
        threads = []
        
        def create_session():
            response = requests.post(f"{BASE_URL}/api/v1/sessions")
            if response.status_code == 200:
                session_ids.append(response.json()["session_id"])
        
        # 创建50个线程同时创建会话
        for _ in range(50):
            thread = threading.Thread(target=create_session)
            threads.append(thread)
            thread.start()
        
        # 等待所有线程完成
        for thread in threads:
            thread.join()
        
        # 验证所有会话ID唯一
        assert len(session_ids) == 50
        assert len(set(session_ids)) == 50
    
    def test_session_expiry(self):
        """SM016: 测试会话过期（需要较短的过期时间用于测试）"""
        # 创建会话
        response = requests.post(f"{BASE_URL}/api/v1/sessions")
        session_id = response.json()["session_id"]
        
        # 验证会话存在
        response = requests.get(f"{BASE_URL}/api/v1/sessions/{session_id}")
        assert response.status_code == 200
        
        # 等待过期时间（这里需要配置较短的测试过期时间）
        time.sleep(10)  # 假设测试环境设置为10秒过期
        
        # 验证会话过期
        response = requests.get(f"{BASE_URL}/api/v1/sessions/{session_id}")
        assert response.status_code == 404
    
    def test_session_activity_update(self):
        """SM021: 测试最后活动时间更新"""
        # 创建会话
        response = requests.post(f"{BASE_URL}/api/v1/sessions")
        session_id = response.json()["session_id"]
        
        # 获取初始活动时间
        response = requests.get(f"{BASE_URL}/api/v1/sessions/{session_id}")
        initial_activity = response.json().get("last_activity")
        
        time.sleep(1)
        
        # 发送消息更新活动时间
        requests.post(f"{BASE_URL}/api/v1/chat", json={
            "session_id": session_id,
            "message": "test"
        })
        
        # 检查活动时间是否更新
        response = requests.get(f"{BASE_URL}/api/v1/sessions/{session_id}")
        new_activity = response.json().get("last_activity")
        
        assert new_activity > initial_activity
    
    def test_session_deletion_cleanup(self):
        """SM014: 测试删除会话后工作目录清理"""
        # 创建会话
        response = requests.post(f"{BASE_URL}/api/v1/sessions")
        session_id = response.json()["session_id"]
        
        # 获取工作目录路径
        response = requests.get(f"{BASE_URL}/api/v1/sessions/{session_id}")
        work_dir = response.json()["work_directory"]
        
        # 在会话中创建文件
        requests.post(f"{BASE_URL}/api/v1/chat", json={
            "session_id": session_id,
            "message": "请创建一个测试文件"
        })
        
        # 验证文件存在
        response = requests.get(f"{BASE_URL}/api/v1/sessions/{session_id}/files")
        assert len(response.json()["files"]) > 0
        
        # 删除会话
        response = requests.delete(f"{BASE_URL}/api/v1/sessions/{session_id}")
        assert response.status_code == 200
        
        # 验证工作目录被清理（这需要额外的API或文件系统检查）
        import os
        assert not os.path.exists(work_dir)
```

## 性能基准测试

### 会话创建性能
```python
def test_session_creation_performance():
    """测试会话创建性能"""
    import time
    
    start_time = time.time()
    
    # 创建100个会话
    for _ in range(100):
        requests.post(f"{BASE_URL}/api/v1/sessions")
    
    end_time = time.time()
    duration = end_time - start_time
    
    # 平均每个会话创建时间应小于100ms
    assert duration / 100 < 0.1
```

### 并发处理性能
```python
def test_concurrent_operations_performance():
    """测试并发操作性能"""
    import concurrent.futures
    
    def session_operation():
        # 创建会话
        response = requests.post(f"{BASE_URL}/api/v1/sessions")
        session_id = response.json()["session_id"]
        
        # 发送消息
        requests.post(f"{BASE_URL}/api/v1/chat", json={
            "session_id": session_id,
            "message": "test"
        })
        
        # 删除会话
        requests.delete(f"{BASE_URL}/api/v1/sessions/{session_id}")
    
    start_time = time.time()
    
    # 并发执行20个完整的会话操作
    with concurrent.futures.ThreadPoolExecutor(max_workers=20) as executor:
        futures = [executor.submit(session_operation) for _ in range(20)]
        concurrent.futures.wait(futures)
    
    end_time = time.time()
    duration = end_time - start_time
    
    # 20个并发操作应在10秒内完成
    assert duration < 10
```

## 测试数据清理

```python
def cleanup_test_sessions():
    """清理测试过程中创建的会话"""
    try:
        # 这里需要实现获取所有会话的API，或者使用管理接口
        # 删除所有测试会话
        pass
    except Exception as e:
        print(f"清理会话时出错: {e}")

@pytest.fixture(autouse=True)
def cleanup_after_test():
    """每个测试后自动清理"""
    yield
    cleanup_test_sessions()
```

## 成功标准

- 会话创建成功率 ≥ 99.9%
- 会话查询准确率 100%
- 会话删除成功率 100%
- 并发处理无数据竞争
- 过期机制正确工作
- 内存使用稳定，无泄漏
- 工作目录正确创建和清理

## 测试执行计划

### 阶段1: 基础功能验证
- SM001-SM015: 会话生命周期基础功能
- SM033-SM036: 数据一致性基础验证

### 阶段2: 高级功能验证
- SM016-SM024: 过期管理功能
- SM025-SM032: 并发处理功能

### 阶段3: 性能和稳定性验证
- SM037-SM046: 异常恢复和资源管理
- 性能基准测试
- 长时间稳定性测试